# Python CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-python/ for more details

version: 2 # use CircleCI 2.0
jobs:
  build:
    working_directory: ~/FN-Inbox
    docker:
      - image: circleci/python:2.7.14

    environment:
      TZ: "/usr/share/zoneinfo/UTC"
      PKG_VERSION: git

    steps:
      - checkout

      - run:
          name: Install postgres
          command: |
            sudo apt-get install apt-transport-https software-properties-common
            sudo add-apt-repository "deb https://apt-archive.postgresql.org/pub/repos/apt trusty-pgdg main"
            # Disable expired Let'sEncrypt DST Root CA X3 certificate
            # https://unix.stackexchange.com/questions/671851/how-to-deal-with-www-postgres-org-certificate-expired
            sudo sed -i 's/mozilla\/DST_Root_CA_X3.crt/!mozilla\/DST_Root_CA_X3.crt/g' /etc/ca-certificates.conf
            sudo update-ca-certificates
            wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
            # Fix for the lastest circle weirdness. Thanks Jose!
            sudo sed -i '/jessie-updates/d' /etc/apt/sources.list
            echo "deb http://archive.debian.org/debian/ jessie-backports main" | sudo tee -a /etc/apt/sources.list
            echo "deb-src http://archive.debian.org/debian/ jessie-backports main" | sudo tee -a /etc/apt/sources.list
            echo "Acquire::Check-Valid-Until false;" | sudo tee -a /etc/apt/apt.conf.d/10-nocheckvalid
            sudo apt-get update
            sudo apt-get install postgresql-9.6
            echo '/usr/lib/postgresql/9.6/bin/:$PATH' >> $BASH_ENV
